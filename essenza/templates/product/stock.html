{% extends 'base.html' %} {% load static %} {% block title %}Stock ·
Essenza{%endblock %} {% block content %}

<style>
  /* ====== ESCAPARATE ====== */
  main {
    max-width: 1100px;
    margin: 40px auto;
    display: grid;
    /* CAMBIADO: Ahora 2 columnas para tarjetas más anchas */
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 20px;
    padding: 0 24px;
  }

  .list-page * {
    box-sizing: border-box;
  }
  .list-page {
    background-color: #faf7f2;
    font-family: "Segoe UI", Arial, sans-serif;
    color: #333;
    padding: 20px 0;
  }
  .list-page .container {
    /* Contenedor principal centrado para el contenido */
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: transparent;
  }

  h1 {
    color: #c06b3e;
    text-align: center;
    margin-bottom: 30px;
    font-size: 32px;
  }

  .filters {
    max-width: 1100px;
    margin: 25px auto 0 auto;
    display: flex;
    margin-bottom: 30px;
  }

  /* ====== TARJETA DE PRODUCTO ====== */

  .product-card {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    padding: 16px;
    transition: transform 0.2s ease;
    display: flex;
    align-items: center;
    gap: 20px;
    text-align: left;
  }

  .product-card:hover {
    transform: translateY(-4px);
  }

  .product-card img {
    width: 140px;
    height: 140px;
    object-fit: contain;
    border-radius: 10px;
    flex-shrink: 0;
  }

  .product-info {
    flex-grow: 1;
  }

  .product-name {
    font-size: 18px;
    color: #333;
    margin-top: 0;
    font-weight: 600;
  }

  /* ====== ESTILO INFORMACION PRODUCTO ====== */

  .product-description {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
    /* Limita el texto a 2 líneas */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-category {
    font-size: 12px;
    color: #888;
    margin-top: 8px;
  }

  .product-price {
    color: #c06b3e;
    font-weight: bold;
    margin-top: 8px;
    font-size: 1.1em;
  }

  /* --- NUEVOS ESTILOS PARA EL STOCK --- */
  .product-stock {
    margin-top: 10px;
    font-weight: 600;
    font-size: 14px;
  }
  /* Advertencias de color */
  .stock-ok {
    color: #28a745;
  } /* Verde */
  .stock-low {
    color: #fd7e14;
  } /* Naranja */
  .stock-out {
    color: #dc3545;
  } /* Rojo */

  /* Formulario de actualización */
  .stock-update-form {
    margin-top: 10px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .stock-update-form input[type="number"] {
    width: 60px;
    padding: 5px 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-family: "Segoe UI", Arial, sans-serif;
  }
  .stock-update-form button {
    padding: 5px 10px;
    background-color: #c06b3e;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
  }
  .stock-update-form button:hover {
    background-color: #a35a34;
  }
</style>

<div class="list-page">
  <div class="container">
    <h1>Stock Essenza</h1>

    <!-- FILTROS: categoría + marca -->
    <div class="filters">
      <div class="custom-dropdown" id="categoryDropdownList">
        <div class="dropdown-button" id="categoryButtonList">
          <span id="categorySelectedList">Todas las categorías</span>
          <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
        <div class="dropdown-menu" id="categoryMenuList">
          <div class="dropdown-item selected" data-value="all">
            <span>Todas las categorías</span>
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
        </div>
      </div>

      <div class="custom-dropdown" id="brandDropdownList">
        <div class="dropdown-button" id="brandButtonList">
          <span id="brandSelectedList">Todas las marcas</span>
          <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
        <div class="dropdown-menu" id="brandMenuList">
          <div class="dropdown-item selected" data-value="all">
            <span>Todas las marcas</span>
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
        </div>
      </div>
    </div>

  <main>
    {% for p in products %}
    <div class="product-card" data-category="{{ p.category }}" data-brand="{{ p.brand|default:''|lower }}">
      {% if p.photo %}
      <img src="{{ p.photo.url }}" alt="{{ p.name }}" />
      {% else %}
      <img src="{% static 'images/default_product.png' %}" />
      {% endif %}

      <div class="product-info">
        <div class="product-name">{{ p.name }}</div>

        {% if p.description %}
        <div class="product-description">{{ p.description }}</div>
        {% endif %} {% if p.category %}
        <div class="product-category">{{ p.get_category_display }}</div>
        {% endif %}

        <div class="product-stock">
          {% with stock_value=p.stock|default:0 %} {% if stock_value <= 0 %}
          <span class="stock-out">Agotado (0)</span>
          {% elif stock_value <= 10 %}
          <span class="stock-low">Stock Bajo: {{ stock_value }}</span>
          {% else %}
          <span class="stock-ok">En Stock: {{ stock_value }}</span>
          {% endif %} {% endwith %}
        </div>

        {% if user.is_authenticated and user.role == 'admin' %}
        <form
          action="{% url 'stock' %}"
          method="post"
          class="stock-update-form"
        >
          {% csrf_token %}
          <input type="hidden" name="product_id" value="{{ p.pk }}" />
          <input
            type="number"
            name="stock"
            value="{{ p.stock|default:0 }}"
            id="stock-{{ p.pk }}"
            min="0"
          />
          <button type="submit">Actualizar</button>
        </form>
        {% endif %}
      </div>
    </div>
    {% endfor %}

    <script>
      // Custom dropdown para stock.html
      (function(){
        const categoryButton = document.getElementById('categoryButtonList');
        const categoryMenu = document.getElementById('categoryMenuList');
        const categorySelected = document.getElementById('categorySelectedList');
        const brandButton = document.getElementById('brandButtonList');
        const brandMenu = document.getElementById('brandMenuList');
        const brandSelected = document.getElementById('brandSelectedList');
        const cards = Array.from(document.querySelectorAll('.product-card'));

        // Toggle dropdowns
        categoryButton.addEventListener('click', (e) => {
          e.stopPropagation();
          categoryMenu.classList.toggle('show');
          brandMenu.classList.remove('show');
        });

        brandButton.addEventListener('click', (e) => {
          e.stopPropagation();
          brandMenu.classList.toggle('show');
          categoryMenu.classList.remove('show');
        });

        document.addEventListener('click', () => {
          categoryMenu.classList.remove('show');
          brandMenu.classList.remove('show');
        });

        // Poblar categorías dinámicamente
        function populateCategories() {
          const categories = new Set();
          cards.forEach(c => {
            const b = (c.dataset.category || '').trim();
            if (b) categories.add(b);
          });

          const sortedCategories = Array.from(categories).sort();
          sortedCategories.forEach(b => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.dataset.value = b;
            item.innerHTML = `
              <span>${b.charAt(0).toUpperCase() + b.slice(1)}</span>
              <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            `;
            categoryMenu.appendChild(item);
          });
        }
        populateCategories();

        // Poblar marcas dinámicamente
        function populateBrands() {
          const brands = new Set();
          cards.forEach(c => {
            const b = (c.dataset.brand || '').trim();
            if (b) brands.add(b);
          });

          const sortedBrands = Array.from(brands).sort();
          sortedBrands.forEach(b => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.dataset.value = b;
            item.innerHTML = `
              <span>${b.charAt(0).toUpperCase() + b.slice(1)}</span>
              <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            `;
            brandMenu.appendChild(item);
          });
        }
        populateBrands();

        // Manejar selección de categoría
        categoryMenu.addEventListener('click', (e) => {
          const item = e.target.closest('.dropdown-item');
          if (!item) return;

          categoryMenu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          categorySelected.textContent = item.querySelector('span').textContent;
          categoryMenu.classList.remove('show');
          applyFilters();
        });

        // Manejar selección de marca
        brandMenu.addEventListener('click', (e) => {
          const item = e.target.closest('.dropdown-item');
          if (!item) return;

          brandMenu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          brandSelected.textContent = item.querySelector('span').textContent;
          brandMenu.classList.remove('show');
          applyFilters();
        });

        // Aplicar filtros
        function applyFilters() {
          const catSelected = categoryMenu.querySelector('.dropdown-item.selected');
          const brandSelItem = brandMenu.querySelector('.dropdown-item.selected');
          const cat = catSelected ? catSelected.dataset.value : 'all';
          const brand = brandSelItem ? brandSelItem.dataset.value : 'all';

          cards.forEach(c => {
            const matchCat = cat === 'all' || (c.dataset.category || '') === cat;
            const matchBrand = brand === 'all' || (c.dataset.brand || '') === brand;
            c.style.display = (matchCat && matchBrand) ? 'flex' : 'none';
          });
        }
      })();
    </script>
  </div>
</div>
{% endblock %}
